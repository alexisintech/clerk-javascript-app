<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClerkJS Script</title>
    <link href="src/style.css" rel="stylesheet" />
  </head>
  <body>
    <div id="signed-in"></div>

    <div id="sign-in">
      <h2>Sign in</h2>
      <form id="sign-in-form">
        <label for="email">Enter email address</label>
        <input name="email" id="sign-in-email" />
        <label for="password">Enter password</label>
        <input name="password" id="sign-in-password" />
        <button type="submit">Continue</button>
      </form>
    </div>

    <form id="verifying" hidden>
      <h2>Verify your account</h2>
      <label for="totp">Enter your code</label>
      <input id="totp" name="code" />
      <label for="backupCode">This code is a backup code</label>
      <input type="checkbox" id="backupCode" name="backupCode" />
      <button type="submit" id="verify-button">Verify</button>
    </form>

    <script
      async
      crossorigin="anonymous"
      data-clerk-publishable-key="pk_test_Y2xlYW4tbWF5Zmx5LTYyLmNsZXJrLmFjY291bnRzLmRldiQ"
      src="https://clean-mayfly-62.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
      type="text/javascript"
    ></script>

    <script>
      window.addEventListener('load', async function () {
        await Clerk.load();

        if (Clerk.user) {
          // Mount user button component
          document.getElementById('signed-in').innerHTML = `
    <div id="user-button"></div>
  `;

          const userbuttonDiv = document.getElementById('user-button');

          Clerk.mountUserButton(userbuttonDiv);
        } else {
          // Handle the sign-in form
          document
            .getElementById('sign-in-form')
            .addEventListener('submit', async (e) => {
              e.preventDefault();

              const formData = new FormData(e.target);
              const emailAddress = formData.get('email');
              const password = formData.get('password');

              try {
                // Start the sign-in process
                await Clerk.client.signIn.create({
                  identifier: emailAddress,
                  password,
                });

                // Hide sign-in form
                document.getElementById('sign-in').setAttribute('hidden', '');
                // Show verification form
                document.getElementById('verifying').removeAttribute('hidden');
              } catch (error) {
                // See https://clerk.com/docs/custom-flows/error-handling
                // for more info on error handling
                console.error(error);
              }
            });

          // Handle the verification form
          document
            .getElementById('verifying')
            .addEventListener('submit', async (e) => {
              const formData = new FormData(e.target);
              const totp = formData.get('totp');
              const backupCode = formData.get('backupCode');

              try {
                const useBackupCode = backupCode ? true : false;
                const code = backupCode ? backupCode : totp;

                // Attempt the TOTP or backup code verification
                const signInAttempt =
                  await Clerk.client.signIn.attemptSecondFactor({
                    strategy: useBackupCode ? 'backup_code' : 'totp',
                    code: code,
                  });

                // If verification was completed, set the session to active
                // and redirect the user
                if (signInAttempt.status === 'complete') {
                  await Clerk.setActive({
                    session: signInAttempt.createdSessionId,
                  });

                  location.reload();
                } else {
                  // If the status is not complete, check why. User may need to
                  // complete further steps.
                  console.error(signInAttempt);
                }
              } catch (error) {
                // See https://clerk.com/docs/custom-flows/error-handling
                // for more info on error handling
                console.error(error);
              }
            });
        }
      });
    </script>
  </body>
</html>
