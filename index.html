<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JavaScript App</title>
    <link href="src/style.css" rel="stylesheet" />
  </head>
  <body>
    <h1>JavaScript Test App</h1>

    <div id="app"></div>

    <div id="auth-links">
      <button onclick="Clerk.openSignUp()">Sign Up</button>
      <button onclick="Clerk.openSignIn()">Sign In</button>
    </div>

    <h2 style="color: red">Roy, test theme on sign in component:</h2>
    <div id="sign-in"></div>

    <h2>Create Organization button:</h2>
    <div id="create-org-button"></div>

    <h2>User Button (for signing out and managing account):</h2>
    <div id="user-button"></div>

    <h2>User info</h2>
    <div id="user-info"></div>

    <div id="no-frontend-api-warning" hidden>
      <h3>No Frontend API found</h3>
      <h4>Add it to the top of <code>src/index.js</code>.</h4>
    </div>

    <h2>Memberships List</h2>
    <ul id="memberships_list"></ul>

    <h2>Invitations List</h2>
    <ul id="invitations_list"></ul>

    <h2>Send a new invitation</h2>
    <form id="new_invitation">
      <div>
        <label>Email address</label>
        <br />
        <input type="email" id="email_address" name="email_address" />
      </div>
      <button>Invite</button>
    </form>

    <h2>Edit Organization</h2>
    <form id="edit_organization">
      <div>
        <label>Name</label>
        <br />
        <input name="name" />
      </div>
      <button>Save</button>
    </form>

    <!-- Use with Script (comment out if using NPM module) -->
    <script>
      // Get this URL and Publishable Key from the Clerk Dashboard
      //my-app pub key
      const clerkPublishableKey =
        "pk_test_ZGlzdGluY3QtbW9zcXVpdG8tMTQuY2xlcmsuYWNjb3VudHMuZGV2JA";
      const frontendApi = "https://distinct-mosquito-14.clerk.accounts.dev";
      const version = "@5.0.0-beta-v5.20"; // Set to appropriate version

      // Creates asynchronous script
      const script = document.createElement("script");
      script.setAttribute("data-clerk-frontend-api", frontendApi);
      script.setAttribute("data-clerk-publishable-key", clerkPublishableKey);
      script.async = true;
      script.src = `${frontendApi}/npm/@clerk/clerk-js${version}/dist/clerk.browser.js`;

      // Adds listener to initialize ClerkJS after it's loaded
      script.addEventListener("load", async function () {
        await window.Clerk.load();

        if (!window.Clerk.user) {
          // ROY !! Testing theme on sign in component
          const signInComponent = document.getElementById("sign-in");
          window.Clerk.mountSignIn(signInComponent, {
            appearance: {
              baseTheme: "neobrutalism",
            },
          });
        } else {
          const userButtonComponent = document.getElementById("user-button");
          window.Clerk.mountUserButton(userButtonComponent, {});
        }

        const createOrganizationComponent =
          document.querySelector("#create-org-button");
        window.Clerk.mountCreateOrganization(createOrganizationComponent, {});

        const userInfo = document.getElementById("user-info");
        const user = await window.Clerk.user;
        console.log(user);
        userInfo.appendChild(
          document.createElement("li")
        ).textContent = `ID: ${user.id}`;
        userInfo.appendChild(
          document.createElement("li")
        ).textContent = `First name: ${user.firstName}`;
        userInfo.appendChild(
          document.createElement("li")
        ).textContent = `Last name: ${user.lastName}`;
        userInfo.appendChild(
          document.createElement("li")
        ).textContent = `Username: ${user.username}`;

        // MEMBERSHIPS LIST
        const { data } = await Clerk.user.getOrganizationMemberships();
        console.log(`Organization Memberships:`, data);

        async function renderMemberships(organization, isAdmin) {
          const list = document.getElementById("memberships_list");
          try {
            const { totalCount, data } = await organization.getMemberships();

            const memberships = data;

            memberships.map((membership) => {
              const li = document.createElement("li");
              li.textContent = `ID: ${membership.id} Identifier: ${membership.publicUserData.identifier} UserId: ${membership.publicUserData.userId} Role: ${membership.role} Permissions: ${membership.permissions}`;

              // Add administrative actions; update role and remove member.
              if (isAdmin) {
                const updateBtn = document.createElement("button");
                updateBtn.textContent = "Change role";
                updateBtn.addEventListener("click", async function (e) {
                  e.preventDefault();
                  const role =
                    membership.role === "admin" ? "org:member" : "admin";
                  await membership.update({ role });
                });
                li.appendChild(updateBtn);

                const removeBtn = document.createElement("button");
                removeBtn.textContent = "Remove";
                removeBtn.addEventListener("click", async function (e) {
                  e.preventDefault();
                  await currentOrganization.removeMember(membership.userId);
                });
                li.appendChild(removeBtn);
              }

              // Add the entry to the list
              list.appendChild(li);
            });
          } catch (err) {
            console.error(err);
          }
        }

        // INVITATIONS LIST
        async function renderInvitations(organization, isAdmin) {
          const list = document.getElementById("invitations_list");
          try {
            const { totalCount, data } = await organization.getInvitations();

            const invitations = data;

            invitations.map((invitation) => {
              const li = document.createElement("li");
              li.textContent = `${invitation.emailAddress} - ${invitation.role}`;

              // Add administrative actions; revoke invitation
              if (isAdmin) {
                const revokeBtn = document.createElement("button");
                revokeBtn.textContent = "Revoke";
                revokeBtn.addEventListener("click", async function (e) {
                  e.preventDefault();
                  await invitation.revoke();
                });
                li.appendChild(revokeBtn);
              }
              // Add the entry to the list
              list.appendChild(li);
            });
          } catch (err) {
            console.error(err);
          }
        }

        async function init() {
          // This is the current organization ID.
          const organizationId = "org_2ap1FzvbwsCfvKid8wJqa5ltkEw";
          const { totalCount, data } =
            await window.Clerk.user.getOrganizationMemberships();

          const organizationMemberships = data;

          const currentMembership = organizationMemberships.find(
            (membership) => membership.organization.id === organizationId
          );
          const currentOrganization = currentMembership.organization;

          if (!currentOrganization) {
            return;
          }
          const isAdmin = currentMembership.role === "admin";

          renderMemberships(currentOrganization, isAdmin);
          renderInvitations(currentOrganization, isAdmin);

          if (isAdmin) {
            const form = document.getElementById("new_invitation");
            form.addEventListener("submit", async function (e) {
              e.preventDefault();
              const inputEl = document.getElementById("email_address");
              if (!inputEl) {
                return;
              }

              try {
                console.log(inputEl.value);
                await currentOrganization.inviteMember({
                  emailAddress: inputEl.value,
                  role: "org:member",
                });
              } catch (err) {
                console.error(err);
              }
            });
          }
        }

        init();
      });
      document.body.appendChild(script);
    </script>
  </body>
</html>
