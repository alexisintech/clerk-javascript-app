<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clerk + JavaScript App</title>
  </head>
  <body>
    <div id="signed-in"></div>

    <p id="error" hidden></p>

    <div id="sign-in">
      <h2>Sign in</h2>
      <form id="sign-in-form">
        <label for="phone">Enter phone number</label>
        <input type="tel" name="phone" id="sign-in-phone" />
        <button type="submit">Continue</button>
      </form>
    </div>

    <form id="verifying" hidden>
      <h2>Verify your phone number</h2>
      <label for="code">Enter your verification code</label>
      <input id="code" name="code" />
      <button type="submit" id="verify-button">Verify</button>
    </form>

    <script
      async
      crossorigin="anonymous"
      data-clerk-publishable-key="pk_test_Y2xlYW4tbWF5Zmx5LTYyLmNsZXJrLmFjY291bnRzLmRldiQ"
      src="https://clean-mayfly-62.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
      type="text/javascript"
    ></script>

    <script>
      window.addEventListener('load', async function () {
        await Clerk.load();

        if (Clerk.user) {
          // Mount user button component
          document.getElementById('signed-in').innerHTML = `
                <div id="user-button"></div>
              `;

          const userbuttonDiv = document.getElementById('user-button');

          Clerk.mountUserButton(userbuttonDiv);
        } else {
          const errorContainer = document.getElementById('error');

          // Handle the sign-in form
          document
            .getElementById('sign-in-form')
            .addEventListener('submit', async (e) => {
              e.preventDefault();

              const formData = new FormData(e.target);
              const phone = formData.get('phone');

              try {
                // Start the sign-up process using the user's identifier. In this case, it's their phone number.
                const { supportedFirstFactors } =
                  await Clerk.client.signIn.create({
                    identifier: phone,
                  });

                // Find the phoneNumberId from all the available first factors for the current sign-in
                const firstPhoneFactor = supportedFirstFactors.find(
                  (factor) => {
                    return factor.strategy === 'phone_code';
                  }
                );

                const { phoneNumberId } = firstPhoneFactor;

                // Prepare first factor verification, specifying
                // the phone code strategy.
                await Clerk.client.signIn.prepareFirstFactor({
                  strategy: 'phone_code',
                  phoneNumberId,
                });

                // Hide sign-in form
                document.getElementById('sign-in').setAttribute('hidden', '');
                // Show verification form
                document.getElementById('verifying').removeAttribute('hidden');
                // Clear any previous errors
                errorContainer.setAttribute('hidden', '');
              } catch (error) {
                errorContainer.removeAttribute('hidden');
                errorContainer.innerHTML = error.errors[0].longMessage;
                console.error(error);
              }
            });

          // Handle the verification form
          document
            .getElementById('verifying')
            .addEventListener('submit', async (e) => {
              const formData = new FormData(e.target);
              const code = formData.get('code');

              try {
                // Verify the phone number
                const verify = await Clerk.client.signIn.attemptFirstFactor({
                  strategy: 'phone_code',
                  code,
                });

                // Now that the user is created, set the session to active.
                await Clerk.setActive({ session: verify.createdSessionId });
              } catch (error) {
                errorContainer.removeAttribute('hidden');
                errorContainer.innerHTML = error.errors[0].longMessage;
                console.error(error);
              }
            });
        }
      });
    </script>
  </body>
</html>
